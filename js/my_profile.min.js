const BASE_URL="http://146.56.183.55:5050";checkLoginUser();const btnBack=document.querySelector(".button-back"),btnMore=document.querySelector(".button-more"),backgroundUpModal=document.querySelector(".background_up-modal"),upModal=document.querySelector(".up-modal"),postItemList=document.querySelectorAll(".item-modal"),logoutBtn_up=Array.from(postItemList).find(item=>"로그아웃"===item.innerText),backgroundPopupModal=document.querySelector(".background_popup-modal"),popupModal=document.querySelector(".popup-modal"),cancelBtn_popup=document.querySelector(".cancel-button_popup"),logoutBtn_popup=document.querySelector(".action-button_popup");btnBack.addEventListener("click",()=>{history.back()}),btnMore.addEventListener("click",()=>{backgroundUpModal.style.display="block",upModal.style.bottom="0"}),backgroundUpModal.addEventListener("click",()=>{backgroundUpModal.style.display="none",upModal.style.bottom="-20rem"}),logoutBtn_up.addEventListener("click",()=>{backgroundPopupModal.style.display="block",popupModal.style.display="block"}),cancelBtn_popup.addEventListener("click",()=>{backgroundPopupModal.style.display="none",popupModal.style.display="none"}),logoutBtn_popup.addEventListener("click",()=>{localStorage.removeItem("Token"),location.href="login.html"});const profileCont=document.querySelector(".cont_profile"),profileFollowers=document.querySelector(".number_followers"),profileFollowings=document.querySelector(".number_followings"),profileFollowersBtn=document.querySelector(".followers_profile"),profileFollowingsBtn=document.querySelector(".followings_profile"),profileImg=document.querySelector(".header_profile").querySelector("img"),profileName=document.querySelector(".name_profile"),profileAccount=document.querySelector(".account_profile"),profileIntro=document.querySelector(".explain_profile"),profileFixButton=document.querySelector(".footer_profile > button:first-child"),addProductButton=document.querySelector(".footer_profile > button:nth-child(2)");async function getProfileData(){try{const myAccountName=localStorage.getItem("accountName"),token=localStorage.getItem("Token"),res=await myFetch(`${BASE_URL}/profile/${myAccountName}`,"get",token);let result=await res.json();result=result.profile,profileFollowers.innerText=result.followerCount,profileFollowings.innerText=result.followingCount,profileImg.src=result.image,profileName.innerText=result.username,profileAccount.innerText=`@ ${result.accountname}`,profileIntro.innerText=result.intro?result.intro:"-"}catch(error){console.log(error)}}getProfileData(),profileFollowersBtn.addEventListener("click",()=>{const accountName=localStorage.getItem("accountName");location.href=`follow.html?accountName=${accountName}&follow=follower`}),profileFollowingsBtn.addEventListener("click",()=>{const accountName=localStorage.getItem("accountName");location.href=`follow.html?accountName=${accountName}&follow=following`}),profileFixButton.addEventListener("click",()=>{window.location.href="profile_modification.html"}),addProductButton.addEventListener("click",()=>{window.location.href="add_product.html"});const onSaleCont=document.querySelector(".cont_on-sale"),onSaleList=document.querySelector(".ul_on-sale"),onSaleFragment=document.createDocumentFragment(),onSaleUpModal=document.querySelector(".on-sale"),onSaleBtnList=document.querySelectorAll(".on-sale .item-modal"),onSaleDeleteBtn_up=onSaleBtnList[0],onSaleModifyBtn_up=onSaleBtnList[1],onSaleLinkBtn_up=onSaleBtnList[2],onSalePopupModal=document.querySelector(".popup-modal+.delete_on-sale"),onSaleCancelBtn_popup=onSalePopupModal.querySelector(".cancel-button_popup"),onSaleDeleteBtn_popup=onSalePopupModal.querySelector(".action-button_popup");async function getOnSaleData(){try{const myAccountName=localStorage.getItem("accountName"),token=localStorage.getItem("Token"),res=await myFetch(`${BASE_URL}/product/${myAccountName}`,"get",token,null),result=await res.json(),productList=result.product;if(!(productList.length>0))return;onSaleCont.style.display="block",productList.forEach(product=>{const price=makeMoneysComma(`${product.price}`),productItem=document.createElement("li");productItem.className+="li_on-sale",productItem.innerHTML=`\n                    <article class="item_on-sale">\n                        <img src="${product.itemImage}" alt="판매상품 ${product.itemName}의 이미지">\n                        <p class="tit_item">\n                            ${product.itemName}\n                        </p>\n                        <p class="price_item">\n                            <strong>\n                                ${price}\n                            </strong>원\n                        </p>\n                    </article>`,onSaleFragment.appendChild(productItem),productItem.addEventListener("click",()=>{backgroundUpModal.style.display="block",onSaleUpModal.style.bottom="0",onSaleDeleteBtn_popup.addEventListener("click",(function deleteFuncWrapper(){deleteItem(product.id,"onSale"),onSaleDeleteBtn_popup.removeEventListener("click",deleteFuncWrapper)})),onSaleModifyBtn_up.addEventListener("click",(function modifyFuncWrapper(){modifyItem(product.id,"onSale"),onSaleModifyBtn_up.removeEventListener("click",modifyFuncWrapper)})),onSaleLinkBtn_up.addEventListener("click",(function LinkFuncWrapper(){moveToLink(product.link),onSaleModifyBtn_up.removeEventListener("click",LinkFuncWrapper)}))})}),onSaleList.appendChild(onSaleFragment),backgroundUpModal.addEventListener("click",()=>{onSaleUpModal.style.bottom="-20rem"})}catch(error){console.log(error)}}async function deleteItem(itemId,itemType){console.log(itemId);const token=localStorage.getItem("Token");if("onSale"===itemType){backgroundPopupModal.style.display="none",backgroundUpModal.style.display="none",onSalePopupModal.style.display="none",onSaleUpModal.style.bottom="-20rem";const res=await myFetch(`${BASE_URL}/product/${itemId}`,"delete",token,null),response=await res.json();window.alert(response.message),location.reload()}else if("content"===itemType){backgroundPopupModal.style.display="none",backgroundUpModal.style.display="none",contentPopupModal.style.display="none",contentUpModal.style.bottom="-20rem";const res=await myFetch(`${BASE_URL}/post/${itemId}`,"delete",token,null),response=await res.json();window.alert(response.message),location.reload()}}function modifyItem(itemId,itemType){"onSale"===itemType?location.href=`profile_modification.html?productid=${itemId}`:"content"===itemType&&(location.href=`upload.html?postid=${itemId}`)}function moveToLink(productLink){window.open(productLink)}onSaleDeleteBtn_up.addEventListener("click",()=>{backgroundPopupModal.style.display="block",onSalePopupModal.style.display="block"}),onSaleCancelBtn_popup.addEventListener("click",()=>{backgroundPopupModal.style.display="none",onSalePopupModal.style.display="none"}),getOnSaleData();const contentsCont=document.querySelector(".cont_contents"),viewStyleCont=document.querySelector(".cont_view-style"),styleBtn=viewStyleCont.querySelectorAll("button"),listStyleBtn=Array.from(styleBtn)[0],pictureStyleBtn=Array.from(styleBtn)[1],userContentsCont=document.querySelector(".cont_user-contents"),contentsList=document.querySelector(".ul_user-contents"),contentsFragment=document.createDocumentFragment(),contentImagesFragment=document.createDocumentFragment(),contentUpModal=document.querySelector(".content"),contentBtnList=document.querySelectorAll(".content .item-modal"),contentDeleteBtn_up=contentBtnList[0],contentModifyBtn_up=contentBtnList[1],contentPopupModal=document.querySelector(".popup-modal+.delete_content"),contentCancelBtn_popup=contentPopupModal.querySelector(".cancel-button_popup"),contentDeleteBtn_popup=contentPopupModal.querySelector(".action-button_popup");async function getContents(){const myAccountName=localStorage.getItem("accountName"),token=localStorage.getItem("Token"),res=await myFetch(`${BASE_URL}/post/${myAccountName}/userpost/?limit=6`,"get",token,null),result=await res.json(),contentsListData=result.post;if(console.log(contentsListData),!(contentsListData.length>0))return;contentsCont.style.display="block";const btnMoreList=[],btnHeartList=[],btnCommentList=[];for(let content of contentsListData){const authorImage=await validateImage(content.author.image,"profile"),contentImage=await validateImage(content.image,"content");let imageHTML="";if(1===contentImage.length&&contentImage[0])imageHTML=`<img src="${contentImage[0]}" alt="post-image" class="content-img_content-info">`;else if(contentImage.length>1){const arr=[];contentImage.forEach(image=>{image&&arr.push(`<img src="${image}" alt="post-image" class="content-img_slide-item">`)}),imageHTML=`<ul class="content-img_slide">${arr.join("")}</ul>`}const contentItem=document.createElement("li");contentItem.className+="li_user-contents",contentItem.innerHTML=`\n        <article class="content_user-contents">\n            <img src="${authorImage}" alt="${content.author.username}님의 프로필 사진" class="img_content-info" />\n            <div class="desc_content-info">\n                <p class="name_content-info">${content.author.username}</p>\n                <p class="email_content-info">@ ${content.author.accountname}</p>\n                <p class="txt_content-info">${content.content}</p>\n                <div class="cont_content-image"></div>\n                ${imageHTML}\n                <div class="cont_buttons">\n                \n                \n                </div>\n                <p class="date_content-info">${makeKoreaDate(content.updatedAt)}</p>\n            </div>\n                    \n        </article>`;const btnMoreHTML=document.createElement("button");btnMoreHTML.className+="btn-more_content button-noneBackground",btnMoreHTML.innerHTML='<img class="" src="src/svg/s-icon-more-vertical.svg" alt="더보기 버튼">',btnMoreHTML.addEventListener("click",()=>{backgroundUpModal.style.display="block",contentUpModal.style.bottom="0",contentDeleteBtn_popup.addEventListener("click",(function deleteFuncWrapper(){deleteItem(content.id,"content"),contentDeleteBtn_popup.removeEventListener("click",deleteFuncWrapper)})),contentModifyBtn_up.addEventListener("click",(function modifyFuncWrapper(){modifyItem(content.id,"content"),contentModifyBtn_up.removeEventListener("click",modifyFuncWrapper)}))});const btnHeartHTML=document.createElement("button");btnHeartHTML.className+="button-like button-noneBackground",btnHeartHTML.innerHTML=`\n            <img src="./src/png/${content.hearted?"icon-heart-active.png":"icon-heart.png"}" alt="">\n            <strong class="count-heart">${content.heartCount}</strong>\n            `,btnHeartHTML.addEventListener("click",()=>{const token=localStorage.getItem("Token");content.hearted?(content.hearted=!1,content.heartCount-=1,content.image="./src/png/icon-heart.png",postHeartReq("delete","unheart",btnHeartHTML,content.id,content.heartCount,content.image)):(content.hearted=!0,content.heartCount+=1,content.image="./src/png/icon-heart-active.png",postHeartReq("post","heart",btnHeartHTML,content.id,content.heartCount,content.image))});const btnCommentHTML=document.createElement("button");btnCommentHTML.className+="button-comment button-noneBackground",btnCommentHTML.innerHTML=`<img src="./src/png/icon-message-circle.png" alt="">\n              <strong class="count-comment">${content.commentCount}</strong>`,btnCommentHTML.addEventListener("click",()=>{location.href=`post.html?id=${content.id}`}),btnMoreList.push(btnMoreHTML),btnHeartList.push(btnHeartHTML),btnCommentList.push(btnCommentHTML),contentsFragment.appendChild(contentItem)}contentsList.appendChild(contentsFragment);const descContentInfoList=document.querySelectorAll(".desc_content-info");Array.from(descContentInfoList).forEach((descContentInfo,index)=>{descContentInfo.after(btnMoreList[index])}),backgroundUpModal.addEventListener("click",()=>{contentUpModal.style.bottom="-20rem"});const contentBtnContList=document.querySelectorAll(".cont_buttons");console.log(contentBtnContList),Array.from(contentBtnContList).forEach((contentBtnCont,index)=>{contentBtnCont.appendChild(btnHeartList[index]),contentBtnCont.appendChild(btnCommentList[index])})}async function validateImage(image,imageType){const token=localStorage.getItem("Token"),imageArray=await image.split(","),newArray=[];for(let image of imageArray)newArray.push(await myFetch(image?`${image}`:"notfoundimage","get",token,null).then(res=>"error"===res?"profile"===imageType?"../src/svg/basic-profile-img.svg":"":image));return newArray}async function postHeartReq(method,postType,dom,id,count,img){const heartCountDom=dom.querySelector("strong"),heartImgDom=dom.querySelector("img"),token=localStorage.getItem("Token"),res=await myFetch(`${BASE_URL}/post/${id}/${postType}`,method,token,null);res.ok?(heartCountDom.innerText=count,heartImgDom.src=img):window.alert("요청에 실패했습니다.")}contentDeleteBtn_up.addEventListener("click",()=>{backgroundPopupModal.style.display="block",contentPopupModal.style.display="block"}),contentCancelBtn_popup.addEventListener("click",()=>{backgroundPopupModal.style.display="none",contentPopupModal.style.display="none"}),getContents(),listStyleBtn.addEventListener("click",()=>{Array.from(listStyleBtn.classList).includes("off")&&Array.from(userContentsCont.classList).includes("picture-style")&&(userContentsCont.classList.remove("picture-style"),listStyleBtn.classList.replace("off","on"),listStyleBtn.querySelector("img").src="../src/png/icon-post-list-on.png",pictureStyleBtn.classList.replace("on","off"),pictureStyleBtn.querySelector("img").src="../src/png/icon-post-album-off.png")}),pictureStyleBtn.addEventListener("click",()=>{Array.from(pictureStyleBtn.classList).includes("off")&&(userContentsCont.classList.add("picture-style"),listStyleBtn.classList.replace("on","off"),listStyleBtn.querySelector("img").src="../src/png/icon-post-list-off.png",pictureStyleBtn.classList.replace("off","on"),pictureStyleBtn.querySelector("img").src="../src/png/icon-post-album-on.png")});const goToHome=document.querySelector(".tap-menu-home"),goToChat=document.querySelector(".tap-menu-chat"),goUpload=document.querySelector(".tap-menu-upload"),goMyProfile=document.querySelector(".tap-menu-user");async function myFetch(url,method,auth="",data=""){const responseData=await fetch(url,{method:method,headers:{"Content-Type":"application/json",Authorization:auth?`Bearer ${auth}`:""},body:"get"===method||"delete"===method?null:data?JSON.stringify(data):""}).then(res=>res.ok?res:"error").catch(err=>err);return responseData}async function checkLoginUser(){localStorage.getItem("Token")||(location.href="login.html")}function getQueryValue(key){const params=new URLSearchParams(location.search),value=params.get(key);return value}function makeKoreaDate(date){const koreaDate=date.split("-").map(value=>parseInt(value));return`${koreaDate[0]}년 ${koreaDate[1]}월 ${koreaDate[2]}일`}function makeMoneysComma(money){let result="";return money.length<4?(result=money,result):(result=","+money.slice(-3),makeMoneysComma(money.slice(0,-3))+result)}goToHome.addEventListener("click",()=>{window.location.href="index.html"}),goToChat.addEventListener("click",()=>{window.location.href="chat_list.html"}),goUpload.addEventListener("click",()=>{window.location.href="upload.html"}),goMyProfile.addEventListener("click",()=>{window.location.href="my_profile.html"});